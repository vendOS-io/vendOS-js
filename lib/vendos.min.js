/*
 * @license
 * vendOS v1.1.0
 * (c) 2020 Social Vend Ltd. trading as vendOS
 * Released under the MIT license
 * vendos.io
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("wolfy87-eventemitter")):"function"==typeof define&&define.amd?define(["wolfy87-eventemitter"],t):(e=e||self).vendOS=t(e.EventEmitter)}(this,(function(e){"use strict";e=e&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e;const t="background: #021019; color: #03FFCF; padding: 5px 10px; border-radius: 2px",s="background: #021019; color: #D44242; padding: 5px 10px; border-radius: 2px",n="machine",o=e=>{console&&console.info&&console.info(`%cVendOS SDK: ${e}`,t)};const i=new class extends e{constructor(){super(),this.socket,this.socketAttempts=0,this.requestQueue=[],this.messageHandlers=[],this.connect()}send(e){this.socket.readyState===WebSocket.OPEN?this.socket.send(e):this.requestQueue.push(e)}message(e){const t=JSON.parse(e.data||null);if(t){const{type:e,id:s}=t;"machine"==e&&null==s?this.emit("machineEvent",t):this.emit(`message.${t.id}`,t)}}open(){this.socket.onclose=this.close.bind(),this.flushQueue()}close(){var e;e="FieldCommand WebSocket closed",console&&console.info&&console.info(`%cVendOS SDK: ${e}`,s),this.socketAttempts=0,this.reconnect()}reconnect(){this.socketAttempts++,5-this.socketAttempts>0?setTimeout(()=>this.connect(),100):this.openFakeSocket()}connect(){o("Attempting to connect to FieldCommand WebSocket"),this.socket=new WebSocket("ws://fieldcommand:3000"),this.socket.onclose=this.reconnect.bind(this),this.socket.onopen=this.open.bind(this),this.socket.onmessage=this.message.bind(this)}flushQueue(){if(this.requestQueue.length){let e;const t=[].concat(this.requestQueue).reverse().filter(t=>{const s=JSON.parse(t),o=s.type&&s.type===n,i=e&&o;return o&&(e=!0),!i}).reverse();this.requestQueue=[],t.forEach(this.send.bind(this))}}openFakeSocket(){o("Cannot connect to socket; falling back to auto-responses"),this.socket={readyState:WebSocket.OPEN,send:e=>{setTimeout(()=>{const t={data:JSON.stringify({...JSON.parse(e),ok:!0})};this.message(t)},1e3)}},this.flushQueue()}};let c=0;class r extends e{constructor(){super(),i.on("machineEvent",e=>{this.emit(`message.${event.id}`,e)})}async send(e){return e.id=c++,i.send(JSON.stringify(e)),await this.receive(e.id)}receive(e){return new Promise(t=>i.once(`message.${e}`,t))}}class a extends r{async vend(e,t){const s=await this.send({type:"machine",action:e,...t});if(s.ok)return s;throw s}channels(){return this.send({type:"machine",action:"channels"})}status(){return this.send({type:"machine",action:"status"})}randomVend(e){return this.vend("randomVend",e)}channelVend(e){return this.vend("channelVend",e)}optimalVend(e){return this.vend("optimalVend",e)}}class h extends r{friendshipStatus(e){return this.send({type:"instagram",action:"friendshipStatus",username:e})}}class d extends r{searchPosts(e,t){return this.send({type:"twitter",action:"searchPosts",username:e,hashtag:t})}}class u extends r{save(e){return this.send({type:"data",action:"set",save:e})}}-1===navigator.userAgent.indexOf("Chrome")&&console.error("It is highly recommended that you develop vendOS in Chrome v.77+.");return class{constructor(){this.Machine=new a,this.Instagram=new h,this.Data=new u,this.Twitter=new d}}}));
