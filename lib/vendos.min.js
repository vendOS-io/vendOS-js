/*
 * @license
 * vendOS v2.0.0
 * (c) 2020 Social Vend Ltd. trading as vendOS
 * Released under the MIT license
 * vendos.io
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).VendOS=t()}(this,(function(){"use strict";var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};var t=function(e,t){return e(t={exports:{}},t.exports),t.exports}((function(t){!function(e){function n(){}var s=n.prototype,o=e.EventEmitter;function i(e,t){for(var n=e.length;n--;)if(e[n].listener===t)return n;return-1}function r(e){return function(){return this[e].apply(this,arguments)}}s.getListeners=function(e){var t,n,s=this._getEvents();if(e instanceof RegExp)for(n in t={},s)s.hasOwnProperty(n)&&e.test(n)&&(t[n]=s[n]);else t=s[e]||(s[e]=[]);return t},s.flattenListeners=function(e){var t,n=[];for(t=0;t<e.length;t+=1)n.push(e[t].listener);return n},s.getListenersAsObject=function(e){var t,n=this.getListeners(e);return n instanceof Array&&((t={})[e]=n),t||n},s.addListener=function(e,t){if(!function e(t){return"function"==typeof t||t instanceof RegExp||!(!t||"object"!=typeof t)&&e(t.listener)}(t))throw new TypeError("listener must be a function");var n,s=this.getListenersAsObject(e),o="object"==typeof t;for(n in s)s.hasOwnProperty(n)&&-1===i(s[n],t)&&s[n].push(o?t:{listener:t,once:!1});return this},s.on=r("addListener"),s.addOnceListener=function(e,t){return this.addListener(e,{listener:t,once:!0})},s.once=r("addOnceListener"),s.defineEvent=function(e){return this.getListeners(e),this},s.defineEvents=function(e){for(var t=0;t<e.length;t+=1)this.defineEvent(e[t]);return this},s.removeListener=function(e,t){var n,s,o=this.getListenersAsObject(e);for(s in o)o.hasOwnProperty(s)&&-1!==(n=i(o[s],t))&&o[s].splice(n,1);return this},s.off=r("removeListener"),s.addListeners=function(e,t){return this.manipulateListeners(!1,e,t)},s.removeListeners=function(e,t){return this.manipulateListeners(!0,e,t)},s.manipulateListeners=function(e,t,n){var s,o,i=e?this.removeListener:this.addListener,r=e?this.removeListeners:this.addListeners;if("object"!=typeof t||t instanceof RegExp)for(s=n.length;s--;)i.call(this,t,n[s]);else for(s in t)t.hasOwnProperty(s)&&(o=t[s])&&("function"==typeof o?i.call(this,s,o):r.call(this,s,o));return this},s.removeEvent=function(e){var t,n=typeof e,s=this._getEvents();if("string"===n)delete s[e];else if(e instanceof RegExp)for(t in s)s.hasOwnProperty(t)&&e.test(t)&&delete s[t];else delete this._events;return this},s.removeAllListeners=r("removeEvent"),s.emitEvent=function(e,t){var n,s,o,i,r=this.getListenersAsObject(e);for(i in r)if(r.hasOwnProperty(i))for(n=r[i].slice(0),o=0;o<n.length;o++)!0===(s=n[o]).once&&this.removeListener(e,s.listener),s.listener.apply(this,t||[])===this._getOnceReturnValue()&&this.removeListener(e,s.listener);return this},s.trigger=r("emitEvent"),s.emit=function(e){var t=Array.prototype.slice.call(arguments,1);return this.emitEvent(e,t)},s.setOnceReturnValue=function(e){return this._onceReturnValue=e,this},s._getOnceReturnValue=function(){return!this.hasOwnProperty("_onceReturnValue")||this._onceReturnValue},s._getEvents=function(){return this._events||(this._events={})},n.noConflict=function(){return e.EventEmitter=o,n},t.exports?t.exports=n:e.EventEmitter=n}("undefined"!=typeof window?window:e||{})}));const n="background: #021019; color: #03FFCF; padding: 5px 10px; border-radius: 2px",s="background: #021019; color: #D44242; padding: 5px 10px; border-radius: 2px",o={WEBSOCKET_ATTEMPT:"Attempting to connect to WebSocket on FieldCommand.",DEVTOOLS_ATTEMPT:"Attempting to connect to vendOS DevTools.",CONNECTED_DEVTOOLS:"Connected to vendOS DevTools.",CONNECTED_WEBSOCKET:"Connected to WebSocket on FieldCommand V__VENDOS_FIELD_COMMAND_VERSION__",WEBSOCKET_CLOSED:"WebSocket on FieldCommand was closed.",DEVTOOLS_CONNECTION_FAILED:"Could not connect to vendOS DevTools. If you'd like to test vendOS JS, please use the vendOS Chrome DevTools [URL], and make sure you click the vendOS DevTools browserAction button in the top-right of the Chrome toolbar in order to activate them for this tab.",WEBSOCKET_CONNECTION_FAILED:"Could not connect to WebSockets. Make sure you're running on a machine with access to FieldCommand."},i=e=>{console&&console.info&&console.info(`%cVendOS SDK: ${e}`,n)},r=e=>{console&&console.info&&console.info(`%cVendOS SDK: ${e}`,s)};function c(e){const{env:t}=window.process||{env:{}};return t[e]}const d=new class extends t{constructor(){super(),this.connectionAttempts=0}send(e){this.socket.readyState===WebSocket.OPEN&&this.socket.send(JSON.stringify(e))}message(e){const t=JSON.parse(e||null);if(t){const{id:e}=t;void 0===e?this.emit("machineEvent",t):this.emit(`message.${t.id}`,(n=["id"],s=t,Object.keys(s).filter(e=>!n.includes(e)).reduce((e,t)=>({...e,[t]:s[t]}),{})))}var n,s}open(){i(o.CONNECTED_WEBSOCKET),this.socket.onclose=this.close.bind()}close(){r(o.WEBSOCKET_CLOSED),this.connectionAttempts=0,this.connectToMachine()}connect(){c("__VENDOS_FIELD_COMMAND_VERSION__")?this.connectToMachine():this.connectToDevtools()}connectToMachine(){i(o.WEBSOCKET_ATTEMPT),this.socket=new WebSocket("ws://fieldcommand:3000"),this.socket.onclose=this.reconnectToMachine.bind(this),this.socket.onopen=this.open.bind(this),this.socket.onmessage=this.message.bind(this)}connectToDevtools(){if(i(o.DEVTOOLS_ATTEMPT),window.__VENDOS_DEVTOOLS_EXTENSION__){const e=window.__VENDOS_DEVTOOLS_EXTENSION__;this.socket={readyState:WebSocket.OPEN,send:t=>e.send(JSON.parse(t))},e.listen(e=>this.message(JSON.stringify(e))),e.handshake(),i(o.CONNECTED_DEVTOOLS)}else setTimeout(this.reconnectToDevtools.bind(this),500)}reconnectToMachine(){this.connectionAttempts++,5-this.connectionAttempts>0?setTimeout(this.connectToMachine.bind(this),100):this.failed()}reconnectToDevtools(){this.connectionAttempts++,5-this.connectionAttempts>0?setTimeout(this.connectToDevtools.bind(this),100):this.failed()}failed(){c("__VENDOS_FIELD_COMMAND_VERSION__")?r(o.WEBSOCKET_CONNECTION_FAILED):r(o.DEVTOOLS_CONNECTION_FAILED)}};let a=0;class h extends t{async send(e){const t=a++;return d.send({...e,id:t}),this.receive(t)}receive(e){return new Promise((t,n)=>{d.once(`message.${e}`,e=>{e.ok?t(e):n(e)})})}}class u extends h{async send(...e){return super.send({resource:"social",...e})}}class l extends u{async send(...e){return super.send({action:"instagram",...e})}friendshipStatus({username:e}){return this.send({method:"friendshipStatus",username:e})}}class f extends u{async send(...e){return super.send({action:"twitter",...e})}searchPosts({username:e,hashtag:t}){return this.send({method:"searchPosts",username:e,hashtag:t})}}class m extends h{async send(e){return super.send({resource:"data",...e})}}class p extends m{async send(e){return super.send({action:"local",...e})}createSet(e){return this.send({method:"createSet",...e})}deleteSet(e){return this.send({method:"deleteSet",...e})}save(e){return this.send({method:"save",...e})}get(e){return this.send({method:"get",...e})}update(e){return this.send({method:"update",...e})}delete(e){return this.send({method:"delete",...e})}}class E extends h{async send(e){return super.send({resource:"machine",...e})}}class O extends E{async send(e){return super.send({action:"vend",...e})}random(e){return this.send({method:"random",...e})}channel(e){return this.send({method:"channel",...e})}optimal(e){return this.send({method:"optimal",...e})}}class v extends E{async send(e){return super.send({action:"channels",...e})}get(){return this.send({method:"get"})}}class _ extends h{async send(e){return super.send({resource:"payment",...e})}}class S extends _{async send(e){return super.send({action:"charge",...e})}instant(e){return this.send({method:"instant",...e})}hold(e){return this.send({method:"hold",...e})}confirm(e){return this.send({method:"confirm",...e})}cancel(){return this.send({method:"cancel"})}}-1===navigator.userAgent.indexOf("Chrome")&&r("It is highly recommended that you develop vendOS in Chrome v.77+.");return class{constructor(){d.connect(),this.Machine={vend:new O,channels:new v},this.Social={twitter:new f,instagram:new l},this.Data={local:new p},this.Payment={charge:new S}}}}));
