!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).VendOS=t()}(this,(function(){"use strict";function e(){}function t(){t.init.call(this)}function n(e){return void 0===e._maxListeners?t.defaultMaxListeners:e._maxListeners}function s(e,t,n){if(t)e.call(n);else for(var s=e.length,o=u(e,s),r=0;r<s;++r)o[r].call(n)}function o(e,t,n,s){if(t)e.call(n,s);else for(var o=e.length,r=u(e,o),i=0;i<o;++i)r[i].call(n,s)}function r(e,t,n,s,o){if(t)e.call(n,s,o);else for(var r=e.length,i=u(e,r),c=0;c<r;++c)i[c].call(n,s,o)}function i(e,t,n,s,o,r){if(t)e.call(n,s,o,r);else for(var i=e.length,c=u(e,i),a=0;a<i;++a)c[a].call(n,s,o,r)}function c(e,t,n,s){if(t)e.apply(n,s);else for(var o=e.length,r=u(e,o),i=0;i<o;++i)r[i].apply(n,s)}function a(t,s,o,r){var i,c,a,d;if("function"!=typeof o)throw new TypeError('"listener" argument must be a function');if((c=t._events)?(c.newListener&&(t.emit("newListener",s,o.listener?o.listener:o),c=t._events),a=c[s]):(c=t._events=new e,t._eventsCount=0),a){if("function"==typeof a?a=c[s]=r?[o,a]:[a,o]:r?a.unshift(o):a.push(o),!a.warned&&(i=n(t))&&i>0&&a.length>i){a.warned=!0;var h=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+s+" listeners added. Use emitter.setMaxListeners() to increase limit");h.name="MaxListenersExceededWarning",h.emitter=t,h.type=s,h.count=a.length,d=h,"function"==typeof console.warn?console.warn(d):console.log(d)}}else a=c[s]=o,++t._eventsCount;return t}function d(e,t,n){var s=!1;function o(){e.removeListener(t,o),s||(s=!0,n.apply(e,arguments))}return o.listener=n,o}function h(e){var t=this._events;if(t){var n=t[e];if("function"==typeof n)return 1;if(n)return n.length}return 0}function u(e,t){for(var n=new Array(t);t--;)n[t]=e[t];return n}e.prototype=Object.create(null),t.EventEmitter=t,t.usingDomains=!1,t.prototype.domain=void 0,t.prototype._events=void 0,t.prototype._maxListeners=void 0,t.defaultMaxListeners=10,t.init=function(){this.domain=null,t.usingDomains&&(void 0).active,this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new e,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},t.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},t.prototype.getMaxListeners=function(){return n(this)},t.prototype.emit=function(e){var t,n,a,d,h,u,l,f="error"===e;if(u=this._events)f=f&&null==u.error;else if(!f)return!1;if(l=this.domain,f){if(t=arguments[1],!l){if(t instanceof Error)throw t;var m=new Error('Uncaught, unspecified "error" event. ('+t+")");throw m.context=t,m}return t||(t=new Error('Uncaught, unspecified "error" event')),t.domainEmitter=this,t.domain=l,t.domainThrown=!1,l.emit("error",t),!1}if(!(n=u[e]))return!1;var p="function"==typeof n;switch(a=arguments.length){case 1:s(n,p,this);break;case 2:o(n,p,this,arguments[1]);break;case 3:r(n,p,this,arguments[1],arguments[2]);break;case 4:i(n,p,this,arguments[1],arguments[2],arguments[3]);break;default:for(d=new Array(a-1),h=1;h<a;h++)d[h-1]=arguments[h];c(n,p,this,d)}return!0},t.prototype.addListener=function(e,t){return a(this,e,t,!1)},t.prototype.on=t.prototype.addListener,t.prototype.prependListener=function(e,t){return a(this,e,t,!0)},t.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,d(this,e,t)),this},t.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,d(this,e,t)),this},t.prototype.removeListener=function(t,n){var s,o,r,i,c;if("function"!=typeof n)throw new TypeError('"listener" argument must be a function');if(!(o=this._events))return this;if(!(s=o[t]))return this;if(s===n||s.listener&&s.listener===n)0==--this._eventsCount?this._events=new e:(delete o[t],o.removeListener&&this.emit("removeListener",t,s.listener||n));else if("function"!=typeof s){for(r=-1,i=s.length;i-- >0;)if(s[i]===n||s[i].listener&&s[i].listener===n){c=s[i].listener,r=i;break}if(r<0)return this;if(1===s.length){if(s[0]=void 0,0==--this._eventsCount)return this._events=new e,this;delete o[t]}else!function(e,t){for(var n=t,s=n+1,o=e.length;s<o;n+=1,s+=1)e[n]=e[s];e.pop()}(s,r);o.removeListener&&this.emit("removeListener",t,c||n)}return this},t.prototype.removeAllListeners=function(t){var n,s;if(!(s=this._events))return this;if(!s.removeListener)return 0===arguments.length?(this._events=new e,this._eventsCount=0):s[t]&&(0==--this._eventsCount?this._events=new e:delete s[t]),this;if(0===arguments.length){for(var o,r=Object.keys(s),i=0;i<r.length;++i)"removeListener"!==(o=r[i])&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=new e,this._eventsCount=0,this}if("function"==typeof(n=s[t]))this.removeListener(t,n);else if(n)do{this.removeListener(t,n[n.length-1])}while(n[0]);return this},t.prototype.listeners=function(e){var t,n=this._events;return n&&(t=n[e])?"function"==typeof t?[t.listener||t]:function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(t):[]},t.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):h.call(e,t)},t.prototype.listenerCount=h,t.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};const l="background: #021019; color: #03FFCF; padding: 5px 10px; border-radius: 2px",f="background: #021019; color: #D44242; padding: 5px 10px; border-radius: 2px",m={WEBSOCKET_ATTEMPT:"Attempting to connect to WebSocket on FieldCommand.",DEVTOOLS_ATTEMPT:"Attempting to connect to vendOS DevTools.",CONNECTED_DEVTOOLS:"Connected to vendOS DevTools.",CONNECTED_WEBSOCKET:"Connected to WebSocket on FieldCommand V__VENDOS_FIELD_COMMAND_VERSION__",WEBSOCKET_CLOSED:"WebSocket on FieldCommand was closed.",DEVTOOLS_CONNECTION_FAILED:"Could not connect to vendOS DevTools. If you'd like to test vendOS JS, please use the vendOS Chrome DevTools [URL], and make sure you click the vendOS DevTools browserAction button in the top-right of the Chrome toolbar in order to activate them for this tab.",WEBSOCKET_CONNECTION_FAILED:"Could not connect to WebSockets. Make sure you're running on a machine with access to FieldCommand."},p=()=>{},v=e=>{console&&console.info&&console.info("%cVendOS SDK: "+e,l)},_=e=>{console&&console.info&&console.info("%cVendOS SDK: "+e,f)};const E=new class extends t{constructor(){super(),this.connectionAttempts=0}send(e){this.socket&&this.socket.readyState===WebSocket.OPEN&&this.socket.send(JSON.stringify(e))}message(e){const{data:t}=e,n=JSON.parse(t||null);if(n){const{id:e,requested:t,data:s}=n;void 0===t||t?void 0!==e&&this.emit("message."+e,s):this.emit("resourceEvent",n)}}open(){v(m.CONNECTED_WEBSOCKET),this.socket.onclose=this.close.bind(),this.succeeded()}close(){_(m.WEBSOCKET_CLOSED),this.connectionAttempts=0,this.connectToMachine()}connect({websocketTestMode:e=!1,websocketUrl:t="ws://fieldcommand:8080",connectedCallback:n=p}){this.__websocketTestMode=e,this.__websocketUrl=t,this.__connectedCallback=n,this.shouldConnectToDevTools()?this.connectToDevtools():this.connectToMachine()}connectToMachine(){v(m.WEBSOCKET_ATTEMPT),this.socket=new WebSocket(this.__websocketUrl),this.socket.onclose=this.reconnectToMachine.bind(this),this.socket.onopen=this.open.bind(this),this.socket.onmessage=this.message.bind(this)}connectToDevtools(){if(v(m.DEVTOOLS_ATTEMPT),window.__VENDOS_DEVTOOLS_EXTENSION__){const e=window.__VENDOS_DEVTOOLS_EXTENSION__,t=e.listen(n=>{"handshake"===n.id&&(t(),this.socket={readyState:WebSocket.OPEN,send:t=>e.send(JSON.parse(t))},e.listen(e=>this.message({data:JSON.stringify(e)})),v(m.CONNECTED_DEVTOOLS),this.succeeded())});e.handshake()}else setTimeout(this.reconnectToDevtools.bind(this),500)}reconnectToMachine(){this.connectionAttempts++,5-this.connectionAttempts>0?setTimeout(this.connectToMachine.bind(this),100):this.failed()}reconnectToDevtools(){this.connectionAttempts++,5-this.connectionAttempts>0?setTimeout(this.connectToDevtools.bind(this),100):this.failed()}failed(){this.shouldConnectToDevTools()?_(m.DEVTOOLS_CONNECTION_FAILED):_(m.WEBSOCKET_CONNECTION_FAILED)}succeeded(){this.__connectedCallback&&this.__connectedCallback()}onResourceEvent(e,t,n){this.on("resourceEvent",s=>{const{resource:o,eventName:r,data:i}=s;o.toLowerCase()===t.toLowerCase()&&e===r&&n(i)})}shouldConnectToDevTools(){return"fieldcommandui"!==window.location.hostname&&!this.__websocketTestMode}};let T=0;class y extends t{async send(e){const t=T++;return E.send({id:t,...e}),this.receive(t)}receive(e){return new Promise((t,n)=>{E.once("message."+e,e=>{e.ok?t(e):n(e)})})}}class w extends y{async send(e){return super.send({...e,resource:"social"})}}class O extends w{async send(e){return super.send({...e,action:"instagram"})}friendshipStatus(e){return this.send({method:"friendshipStatus",data:e})}}class g extends w{async send(e){return super.send({...e,action:"twitter"})}searchPosts(e){return this.send({method:"searchPosts",data:e})}}class C extends y{async send(e){return super.send({...e,resource:"data"})}}class b extends C{async send(e){return super.send({...e,action:"local"})}createSet(e){return this.send({method:"createSet",data:e})}deleteSet(e){return this.send({method:"deleteSet",data:e})}save(e){return this.send({method:"save",data:e})}get(e){return this.send({method:"get",data:e})}update(e){return this.send({method:"update",data:e})}delete(e){return this.send({method:"delete",data:e})}}class S extends y{async send(e){return super.send({...e,resource:"machine"})}}class L extends S{async send(e){return super.send({...e,action:"vend"})}random(e){return this.send({method:"random",data:e})}channel(e){return this.send({method:"channel",data:e})}optimal(e){return this.send({method:"optimal",data:e})}product(e){return this.send({method:"product",data:e})}}class k extends S{async send(e){return super.send({...e,action:"channels"})}get(){return this.send({method:"get"})}}class D extends S{async send(e){return super.send({...e,action:"products"})}get(){return this.send({method:"get"})}}class N extends y{async send(e){return super.send({...e,resource:"payment"})}}class x extends N{async send(e){return super.send({...e,action:"charge"})}instant(e){return this.send({method:"instant",data:e})}hold(e){return this.send({method:"hold",data:e})}confirm(e){return this.send({method:"confirm",data:e})}cancel(){return this.send({method:"cancel"})}}class A extends y{async send(e){return super.send({...e,resource:"email"})}}class M extends A{async send(e){return super.send({...e,action:"send"})}template(e){return this.send({method:"template",data:e})}}-1===navigator.userAgent.indexOf("Chrome")&&_("It is highly recommended that you develop vendOS in Chrome v.77+.");return class{constructor({websocketTestMode:e,websocketUrl:t,connectedCallback:n}={}){if(this.constructor.instance)return this.constructor.instance;this.constructor.instance=this,E.connect({websocketTestMode:e,websocketUrl:t,connectedCallback:n}),this.Machine={vend:new L,channels:new k,products:new D,on:(e,t)=>E.onResourceEvent(e,"machine",t)},this.Social={twitter:new g,instagram:new O},this.Data={local:new b},this.Payment={charge:new x},this.Email={send:new M},this.Throughput=new y}}}));
